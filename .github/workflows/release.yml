name: è‡ªåŠ¨å‘å¸ƒ Release

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é…ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º release
  packages: write  # éœ€è¦åŒ…æƒé™
  
jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²ï¼Œç”¨äºç”Ÿæˆå‘å¸ƒè¯´æ˜
      
    - name: è®¾ç½® Java ç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ç¼“å­˜ Maven ä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"
        
    - name: æ›´æ–° pom.xml ç‰ˆæœ¬
      run: |
        VERSION=${{ steps.version.outputs.version }}
        # ç§»é™¤ v å‰ç¼€
        VERSION_NUMBER=${VERSION#v}
        echo "è®¾ç½®ç‰ˆæœ¬å·ä¸º: $VERSION_NUMBER"
        mvn versions:set -DnewVersion=$VERSION_NUMBER -DgenerateBackupPoms=false
        echo "ç‰ˆæœ¬æ›´æ–°å®Œæˆ"
        cat pom.xml | grep -A5 -B5 "<version>"
        
    - name: ç¼–è¯‘å’Œæ‰“åŒ…
      run: |
        echo "å¼€å§‹ç¼–è¯‘é¡¹ç›®..."
        mvn clean compile
        echo "å¼€å§‹æ‰“åŒ…é¡¹ç›®..."
        mvn package -DskipTests
        
    - name: éªŒè¯æ„å»ºäº§ç‰©
      run: |
        echo "éªŒè¯æ„å»ºäº§ç‰©..."
        ls -la target/
        VERSION_NUMBER=${{ steps.version.outputs.version }}
        VERSION_NUMBER=${VERSION_NUMBER#v}
        
        # æ£€æŸ¥ä¸»è¦ JAR æ–‡ä»¶
        JAR_FILE="target/RemoveExtraBlankLines-$VERSION_NUMBER.jar"
        if [ ! -f "$JAR_FILE" ]; then
          echo "é”™è¯¯: JAR æ–‡ä»¶æœªç”Ÿæˆ: $JAR_FILE"
          echo "æŸ¥æ‰¾æ‰€æœ‰ç”Ÿæˆçš„ JAR æ–‡ä»¶:"
          find target/ -name "*.jar" -type f
          exit 1
        fi
        echo "æ„å»ºäº§ç‰©éªŒè¯æˆåŠŸ: $JAR_FILE"
        
    - name: é‡å‘½åæ„å»ºäº§ç‰©
      run: |
        VERSION=${{ steps.version.outputs.version }}
        VERSION_NUMBER=${VERSION#v}
        SOURCE_JAR="target/RemoveExtraBlankLines-$VERSION_NUMBER.jar"
        TARGET_JAR="target/RemoveExtraBlankLines-$VERSION.jar"
        
        if [ -f "$SOURCE_JAR" ]; then
          cp "$SOURCE_JAR" "$TARGET_JAR"
          echo "å·²åˆ›å»ºå¸¦ç‰ˆæœ¬æ ‡ç­¾çš„æ–‡ä»¶: $TARGET_JAR"
        else
          echo "æºæ–‡ä»¶ä¸å­˜åœ¨: $SOURCE_JAR"
          exit 1
        fi

    - name: è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾
      id: prev_version
      run: |
        # è·å–å½“å‰æ ‡ç­¾ä¹‹å‰çš„æœ€æ–°æ ‡ç­¾
        PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${{ steps.version.outputs.version }}$" | head -n 1)
        if [ -z "$PREV_TAG" ]; then
          echo "prev_tag=" >> $GITHUB_OUTPUT
          echo "è¿™æ˜¯ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ²¡æœ‰å‰ä¸€ä¸ªç‰ˆæœ¬"
        else
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "å‰ä¸€ä¸ªç‰ˆæœ¬: $PREV_TAG"
        fi

    - name: æå–READMEä¸­çš„æ›´æ–°æ—¥å¿—
      id: changelog
      run: |
        VERSION=${{ steps.version.outputs.version }}
        VERSION_NUMBER=${VERSION#v}
        
        # å°è¯•ä»README.mdä¸­æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
        if grep -q "### v$VERSION_NUMBER" README.md; then
          echo "ä»README.mdä¸­æå–ç‰ˆæœ¬ $VERSION_NUMBER çš„æ›´æ–°æ—¥å¿—..."
          
          # æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
          sed -n "/### v$VERSION_NUMBER/,/### v/p" README.md | head -n -1 > current_changelog.md
          
          # å¦‚æœæ–‡ä»¶ä¸ä¸ºç©ºï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤å†…å®¹
          if [ -s current_changelog.md ]; then
            echo "æˆåŠŸæå–åˆ°æ›´æ–°æ—¥å¿—"
            cat current_changelog.md
          else
            echo "æ›´æ–°æ—¥å¿—ä¸ºç©ºï¼Œå°†ä½¿ç”¨é»˜è®¤å†…å®¹"
            echo "" > current_changelog.md
          fi
        else
          echo "åœ¨README.mdä¸­æœªæ‰¾åˆ°ç‰ˆæœ¬ $VERSION_NUMBER çš„æ›´æ–°æ—¥å¿—"
          echo "" > current_changelog.md
        fi

    - name: è·å–Gitæäº¤å†å²
      id: git_changes
      run: |
        VERSION=${{ steps.version.outputs.version }}
        PREV_TAG="${{ steps.prev_version.outputs.prev_tag }}"
        
        echo "## ğŸ“ ä»£ç å˜æ›´" > git_changes.md
        
        if [ -n "$PREV_TAG" ]; then
          echo "è·å–ä» $PREV_TAG åˆ° $VERSION çš„æäº¤å†å²..."
          
          # è·å–æäº¤å†å²ï¼Œæ’é™¤mergeæäº¤
          git log --pretty=format:"- %s" --no-merges "$PREV_TAG..$VERSION" >> git_changes.md
          
          # è·å–æ–‡ä»¶å˜æ›´ç»Ÿè®¡
          echo -e "\n\n## ğŸ“Š å˜æ›´ç»Ÿè®¡" >> git_changes.md
          CHANGED_FILES=$(git diff --name-only "$PREV_TAG..$VERSION" | wc -l)
          ADDED_LINES=$(git diff --shortstat "$PREV_TAG..$VERSION" | grep -o '[0-9]* insertion' | grep -o '[0-9]*' || echo "0")
          DELETED_LINES=$(git diff --shortstat "$PREV_TAG..$VERSION" | grep -o '[0-9]* deletion' | grep -o '[0-9]*' || echo "0")
          
          echo "- ğŸ“ å˜æ›´æ–‡ä»¶æ•°: $CHANGED_FILES" >> git_changes.md
          echo "- â• æ–°å¢ä»£ç è¡Œ: $ADDED_LINES" >> git_changes.md  
          echo "- â– åˆ é™¤ä»£ç è¡Œ: $DELETED_LINES" >> git_changes.md
          
          # åˆ—å‡ºä¸»è¦å˜æ›´çš„æ–‡ä»¶
          echo -e "\n## ğŸ”„ ä¸»è¦å˜æ›´æ–‡ä»¶" >> git_changes.md
          git diff --name-only "$PREV_TAG..$VERSION" | head -10 | sed 's/^/- /' >> git_changes.md
          
        else
          echo "- ğŸ‰ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ" >> git_changes.md
          echo "- âœ¨ å®ç°æ ¸å¿ƒåŠŸèƒ½å’Œæ¶æ„" >> git_changes.md
        fi
        
    - name: åˆ†æä»£ç ç‰¹æ€§
      id: features
      run: |
        VERSION=${{ steps.version.outputs.version }}
        
        echo "## ğŸ¯ ä¸»è¦ç‰¹æ€§" > features.md
        
        # åˆ†æJavaæ–‡ä»¶ï¼Œæå–ä¸»è¦ç±»å’ŒåŠŸèƒ½
        echo "### ğŸ—ï¸ æ¶æ„ç»„ä»¶" >> features.md
        find src/main/java -name "*.java" -type f | while read file; do
          class_name=$(basename "$file" .java)
          if grep -q "class $class_name" "$file"; then
            # æå–ç±»çš„æ³¨é‡Šè¯´æ˜
            if grep -B5 "class $class_name" "$file" | grep -q "\*"; then
              description=$(grep -B10 "class $class_name" "$file" | grep "^\s*\*" | grep -v "^\s*\*/" | head -1 | sed 's/^\s*\*\s*//')
              if [ -n "$description" ]; then
                echo "- **$class_name**: $description" >> features.md
              else
                echo "- **$class_name**: æ ¸å¿ƒç»„ä»¶" >> features.md
              fi
            else
              echo "- **$class_name**: æ ¸å¿ƒç»„ä»¶" >> features.md
            fi
          fi
        done
        
        # åˆ†æé…ç½®å’Œç‰¹æ€§
        echo -e "\n### âš™ï¸ é…ç½®æ”¯æŒ" >> features.md
        if grep -q "PluginConfig" src/main/java/oxff/org/config/PluginConfig.java 2>/dev/null; then
          echo "- ğŸ›ï¸ æ¨¡å—ç”Ÿæ•ˆæ§åˆ¶ (Proxy, Repeater, Intruder, Extensions)" >> features.md
          echo "- ğŸŒ ç›®æ ‡åŸŸæ§åˆ¶ (åŸºäºBurp Suiteç›®æ ‡èŒƒå›´)" >> features.md
        fi
        
        # åˆ†æäºŒè¿›åˆ¶æ£€æµ‹èƒ½åŠ›
        if grep -q "BINARY_SIGNATURES" src/main/java/oxff/org/util/ContentAnalyzer.java 2>/dev/null; then
          BINARY_TYPES=$(grep -c "// " src/main/java/oxff/org/util/ContentAnalyzer.java | head -1)
          echo "- ğŸ” æ™ºèƒ½äºŒè¿›åˆ¶æ£€æµ‹ (æ”¯æŒ $BINARY_TYPES+ ç§æ–‡ä»¶æ ¼å¼)" >> features.md
        fi
        
        echo "- ğŸš€ é«˜æ€§èƒ½å¤„ç†å’Œå®‰å…¨é”™è¯¯å¤„ç†" >> features.md
        echo "- ğŸ“ è¯¦ç»†çš„æ—¥å¿—è®°å½•å’Œé…ç½®éªŒè¯" >> features.md
        
    - name: ç”ŸæˆåŠ¨æ€å‘å¸ƒè¯´æ˜
      id: release_notes
      run: |
        VERSION=${{ steps.version.outputs.version }}
        VERSION_NUMBER=${VERSION#v}
        
        cat > release_notes.md << EOF
        ## ğŸš€ Remove Extra Blank Lines $VERSION
        
        > Burp Suite æ’ä»¶ - æ™ºèƒ½å»é™¤ HTTP æŠ¥æ–‡ä¸­çš„å¤šä½™ç©ºè¡Œ
        
        ---
        
        EOF
        
        # å¦‚æœæœ‰READMEä¸­çš„æ›´æ–°æ—¥å¿—ï¼Œä½¿ç”¨å®ƒ
        if [ -s current_changelog.md ]; then
          echo "### ğŸ”„ ç‰ˆæœ¬æ›´æ–°" >> release_notes.md
          cat current_changelog.md >> release_notes.md
          echo "" >> release_notes.md
        fi
        
        # æ·»åŠ ä»£ç ç‰¹æ€§åˆ†æ
        cat features.md >> release_notes.md
        echo "" >> release_notes.md
        
        # æ·»åŠ Gitå˜æ›´å†å²
        cat git_changes.md >> release_notes.md
        echo "" >> release_notes.md
        
        cat >> release_notes.md << EOF
        
        ---
        
        ## ğŸ› ï¸ å®‰è£…å’Œä½¿ç”¨
        
        ### ğŸ“¦ å¿«é€Ÿå®‰è£…
        1. ä¸‹è½½ \`RemoveExtraBlankLines-$VERSION.jar\`
        2. åœ¨ Burp Suite ä¸­: Extensions â†’ Installed â†’ Add
        3. é€‰æ‹©ä¸‹è½½çš„ JAR æ–‡ä»¶ï¼Œç‚¹å‡» Next
        4. æ’ä»¶è‡ªåŠ¨åŠ è½½å¹¶å¼€å§‹å·¥ä½œ âœ…
        
        ### ğŸ“‹ ä½¿ç”¨è¯´æ˜
        - **é»˜è®¤è¡Œä¸º**: æ’ä»¶åœ¨æ‰€æœ‰æ¨¡å—ä¸­è‡ªåŠ¨å¯ç”¨
        - **é…ç½®æ§åˆ¶**: å¯é€šè¿‡ä¿®æ”¹ä»£ç è‡ªå®šä¹‰æ¨¡å—å’ŒåŸŸåæ§åˆ¶
        - **æ—¥å¿—æŸ¥çœ‹**: Extensions â†’ Output é¢æ¿æŸ¥çœ‹å¤„ç†æ—¥å¿—
        
        ## ğŸ“š æ–‡æ¡£èµ„æº
        
        | æ–‡æ¡£ | æè¿° |
        |------|------|
        | [ğŸ“– README.md](https://github.com/${{ github.repository }}/blob/main/README.md) | å®Œæ•´ä½¿ç”¨æ–‡æ¡£å’Œç‰¹æ€§è¯´æ˜ |
        | [ğŸ§ª TEST_CASES.md](https://github.com/${{ github.repository }}/blob/main/TEST_CASES.md) | è¯¦ç»†æµ‹è¯•ç”¨ä¾‹å’ŒéªŒè¯æ–¹æ³• |
        | [âš™ï¸ CONFIGURATION_GUIDE.md](https://github.com/${{ github.repository }}/blob/main/CONFIGURATION_GUIDE.md) | é«˜çº§é…ç½®æŒ‡å— |
        
        ## ğŸ”§ æŠ€æœ¯è§„æ ¼
        
        - **å¼€å‘è¯­è¨€**: Java 17+
        - **æ”¯æŒç‰ˆæœ¬**: Burp Suite Community/Professional Edition
        - **APIä¾èµ–**: Montoya API 2023.12.1
        - **æ„å»ºå·¥å…·**: Maven 3.x
        - **å…¼å®¹æ€§**: Windows, macOS, Linux
        
        ## ğŸ› é—®é¢˜åé¦ˆ
        
        é‡åˆ°é—®é¢˜ï¼Ÿæˆ‘ä»¬å¾ˆä¹æ„å¸®åŠ©ï¼
        - ğŸ [æäº¤BugæŠ¥å‘Š](https://github.com/${{ github.repository }}/issues/new?template=bug_report.md)
        - ğŸ’¡ [åŠŸèƒ½å»ºè®®](https://github.com/${{ github.repository }}/issues/new?template=feature_request.md)
        - ğŸ’¬ [è®¨è®ºäº¤æµ](https://github.com/${{ github.repository }}/discussions)
        
        ## ğŸ™ è‡´è°¢
        
        æ„Ÿè°¢æ‰€æœ‰ä½¿ç”¨å’Œåé¦ˆçš„ç”¨æˆ·ï¼æ‚¨çš„æ”¯æŒæ˜¯æˆ‘ä»¬æŒç»­æ”¹è¿›çš„åŠ¨åŠ›ã€‚
        
        ---
        
        **æ„å»ºä¿¡æ¯**
        - æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - æ„å»ºç¯å¢ƒ: GitHub Actions
        - Javaç‰ˆæœ¬: $(java -version 2>&1 | head -n 1)
        EOF
        
        echo "âœ… åŠ¨æ€å‘å¸ƒè¯´æ˜ç”Ÿæˆå®Œæˆ"
        echo "ğŸ“„ å‘å¸ƒè¯´æ˜é¢„è§ˆ:"
        echo "===================="
        head -20 release_notes.md
        echo "===================="
        
    - name: åˆ›å»º GitHub Release å¹¶ä¸Šä¼ æ–‡ä»¶
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: "ğŸš€ Remove Extra Blank Lines ${{ steps.version.outputs.version }}"
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: false  # ç¦ç”¨GitHubè‡ªåŠ¨ç”Ÿæˆï¼Œä½¿ç”¨æˆ‘ä»¬çš„è‡ªå®šä¹‰å†…å®¹
        files: |
          target/RemoveExtraBlankLines-${{ steps.version.outputs.version }}.jar
          target/RemoveExtraBlankLines-*-sources.jar
      
    - name: å‘å¸ƒå®Œæˆé€šçŸ¥
      run: |
        VERSION=${{ steps.version.outputs.version }}
        echo "ğŸ‰ å‘å¸ƒå®Œæˆ!"
        echo "ç‰ˆæœ¬: $VERSION"
        echo "ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/$VERSION"
        echo "æ„å»ºæ—¶é—´: $(date)"
        echo ""
        echo "ğŸ“‹ å‘å¸ƒå†…å®¹:"
        echo "- JARæ–‡ä»¶: RemoveExtraBlankLines-$VERSION.jar"
        echo "- æºç åŒ…: RemoveExtraBlankLines-*-sources.jar"
        echo "- è¯¦ç»†å‘å¸ƒè¯´æ˜å·²è‡ªåŠ¨ç”Ÿæˆ" 