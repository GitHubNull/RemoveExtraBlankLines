name: è‡ªåŠ¨å‘å¸ƒ Release

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é…ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º release
  packages: write  # éœ€è¦åŒ…æƒé™
  
jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Java ç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ç¼“å­˜ Maven ä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"
        
    - name: æ›´æ–° pom.xml ç‰ˆæœ¬
      run: |
        VERSION=${{ steps.version.outputs.version }}
        # ç§»é™¤ v å‰ç¼€
        VERSION_NUMBER=${VERSION#v}
        echo "è®¾ç½®ç‰ˆæœ¬å·ä¸º: $VERSION_NUMBER"
        mvn versions:set -DnewVersion=$VERSION_NUMBER -DgenerateBackupPoms=false
        echo "ç‰ˆæœ¬æ›´æ–°å®Œæˆ"
        cat pom.xml | grep -A5 -B5 "<version>"
        
    - name: ç¼–è¯‘å’Œæ‰“åŒ…
      run: |
        echo "å¼€å§‹ç¼–è¯‘é¡¹ç›®..."
        mvn clean compile
        echo "å¼€å§‹æ‰“åŒ…é¡¹ç›®..."
        mvn package -DskipTests
        
    - name: éªŒè¯æ„å»ºäº§ç‰©
      run: |
        echo "éªŒè¯æ„å»ºäº§ç‰©..."
        ls -la target/
        VERSION_NUMBER=${{ steps.version.outputs.version }}
        VERSION_NUMBER=${VERSION_NUMBER#v}
        
        # æ£€æŸ¥ä¸»è¦ JAR æ–‡ä»¶
        JAR_FILE="target/RemoveExtraBlankLines-$VERSION_NUMBER.jar"
        if [ ! -f "$JAR_FILE" ]; then
          echo "é”™è¯¯: JAR æ–‡ä»¶æœªç”Ÿæˆ: $JAR_FILE"
          echo "æŸ¥æ‰¾æ‰€æœ‰ç”Ÿæˆçš„ JAR æ–‡ä»¶:"
          find target/ -name "*.jar" -type f
          exit 1
        fi
        echo "æ„å»ºäº§ç‰©éªŒè¯æˆåŠŸ: $JAR_FILE"
        
    - name: é‡å‘½åæ„å»ºäº§ç‰©
      run: |
        VERSION=${{ steps.version.outputs.version }}
        VERSION_NUMBER=${VERSION#v}
        SOURCE_JAR="target/RemoveExtraBlankLines-$VERSION_NUMBER.jar"
        TARGET_JAR="target/RemoveExtraBlankLines-$VERSION.jar"
        
        if [ -f "$SOURCE_JAR" ]; then
          cp "$SOURCE_JAR" "$TARGET_JAR"
          echo "å·²åˆ›å»ºå¸¦ç‰ˆæœ¬æ ‡ç­¾çš„æ–‡ä»¶: $TARGET_JAR"
        else
          echo "æºæ–‡ä»¶ä¸å­˜åœ¨: $SOURCE_JAR"
          exit 1
        fi
        
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
      id: release_notes
      run: |
        VERSION=${{ steps.version.outputs.version }}
        cat > release_notes.md << EOF
        ## ğŸš€ Remove Extra Blank Lines v${VERSION#v}
        
        ### ğŸ“‹ ç‰ˆæœ¬ç‰¹æ€§
        - âœ… æ™ºèƒ½äºŒè¿›åˆ¶å†…å®¹æ£€æµ‹ï¼Œé¿å…ç ´åäºŒè¿›åˆ¶æ•°æ®
        - âœ… æ¨¡å—åŒ–æ¶æ„è®¾è®¡ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
        - âœ… æ”¯æŒå¤šç§å­—ç¬¦ç¼–ç å’Œæ¢è¡Œç¬¦æ ¼å¼
        - âœ… é«˜æ€§èƒ½å¤„ç†ï¼Œé‡‡ç”¨é‡‡æ ·æ£€æµ‹æœºåˆ¶
        - âœ… å…¨é¢çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
        
        ### ğŸ› ï¸ å®‰è£…æ–¹æ³•
        1. ä¸‹è½½ \`RemoveExtraBlankLines-$VERSION.jar\`
        2. åœ¨ Burp Suite ä¸­è½¬åˆ° Extensions -> Installed
        3. ç‚¹å‡» Addï¼Œé€‰æ‹©ä¸‹è½½çš„ JAR æ–‡ä»¶
        4. æ’ä»¶å°†è‡ªåŠ¨åŠ è½½å¹¶å¼€å§‹å·¥ä½œ
        
        ### ğŸ“– è¯¦ç»†æ–‡æ¡£
        è¯·å‚é˜…é¡¹ç›®çš„ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) å’Œ [TEST_CASES.md](https://github.com/${{ github.repository }}/blob/main/TEST_CASES.md)
        
        ### ğŸ”§ æŠ€æœ¯ä¿¡æ¯
        - **Java ç‰ˆæœ¬**: 17+
        - **Burp Suite**: Community/Professional Edition
        - **Montoya API**: 2023.12.1
        
        ### ğŸ› é—®é¢˜åé¦ˆ
        å¦‚æœæ‚¨é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­æäº¤åé¦ˆã€‚
        EOF
        
    - name: åˆ›å»º GitHub Release å¹¶ä¸Šä¼ æ–‡ä»¶
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Remove Extra Blank Lines ${{ steps.version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          target/RemoveExtraBlankLines-${{ steps.version.outputs.version }}.jar
          target/RemoveExtraBlankLines-*-sources.jar
      
    - name: å‘å¸ƒå®Œæˆé€šçŸ¥
      run: |
        VERSION=${{ steps.version.outputs.version }}
        echo "ğŸ‰ å‘å¸ƒå®Œæˆ!"
        echo "ç‰ˆæœ¬: $VERSION"
        echo "ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/$VERSION"
        echo "æ„å»ºæ—¶é—´: $(date)" 